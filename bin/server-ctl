#!/usr/bin/env bash
#
# Server Setup CLI
# Generic server hardening for freshly provisioned VPS instances
#
# Usage: server-ctl <command> [args...]
#
# Commands:
#   setup [--ports 22,80,443] [--timezone UTC]  Harden server (Docker, UFW, SSH, auto-updates)
#   setup-docker                                Install Docker and Docker Compose only
#   setup-ufw [--ports 22,80,443]               Configure UFW firewall only
#   setup-ssh                                   Harden SSH configuration only
#   setup-updates                               Configure unattended upgrades only
#
# Options:
#   -y, --yes    Skip confirmation prompts
#
# Notes:
#   Run these commands ON the target server (e.g., via ssh).
#   The 'setup' command runs all steps in sequence.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "$0")")" && pwd)"
source "$SCRIPT_DIR/../lib/common.sh"

DEFAULT_PORTS="22,80,443"
DEFAULT_TIMEZONE="UTC"

log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
log_success() { echo -e "${GREEN}[OK]${NC} $*"; }

cmd_setup_docker() {
    log_info "Installing essential packages..."
    export DEBIAN_FRONTEND=noninteractive
    apt-get update
    apt-get install -y \
        apt-transport-https \
        ca-certificates \
        curl \
        gnupg \
        lsb-release \
        git \
        htop \
        vim \
        jq

    log_info "Installing Docker..."
    if ! command -v docker &> /dev/null; then
        curl -fsSL https://get.docker.com | sh
        systemctl enable docker
        systemctl start docker
    else
        log_info "Docker already installed"
    fi

    log_info "Installing Docker Compose..."
    if ! docker compose version &> /dev/null; then
        apt-get install -y docker-compose-plugin
    else
        log_info "Docker Compose already installed"
    fi

    log_success "Docker setup complete"
    docker --version
    docker compose version
}

cmd_setup_ufw() {
    local ports=${1:-$DEFAULT_PORTS}

    log_info "Configuring UFW firewall..."
    apt-get install -y ufw

    ufw default deny incoming
    ufw default allow outgoing

    IFS=',' read -ra port_list <<< "$ports"
    for port_spec in "${port_list[@]}"; do
        local port protocol=""
        if [[ "$port_spec" == */udp ]]; then
            protocol="/udp"
            port="${port_spec%/udp}"
        elif [[ "$port_spec" == */tcp ]]; then
            protocol="/tcp"
            port="${port_spec%/tcp}"
        else
            port="$port_spec"
        fi
        log_info "Allowing port ${port}${protocol}"
        ufw allow "${port}${protocol}"
    done

    ufw --force enable
    log_success "UFW configured"
}

cmd_setup_ssh() {
    log_info "Hardening SSH configuration..."
    apt-get install -y fail2ban
    systemctl enable fail2ban
    systemctl start fail2ban

    if ! grep -q "^PasswordAuthentication no" /etc/ssh/sshd_config; then
        sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
        sed -i 's/^#*PermitRootLogin.*/PermitRootLogin prohibit-password/' /etc/ssh/sshd_config
        sed -i 's/^#*PermitEmptyPasswords.*/PermitEmptyPasswords no/' /etc/ssh/sshd_config
        sed -i 's/^#*X11Forwarding.*/X11Forwarding no/' /etc/ssh/sshd_config
        systemctl restart ssh || systemctl restart sshd
    fi

    passwd -l root

    log_success "SSH hardened"
}

cmd_setup_updates() {
    log_info "Configuring automatic updates..."
    apt-get install -y unattended-upgrades apt-listchanges

    cat > /etc/apt/apt.conf.d/50unattended-upgrades << 'UPGEOF'
Unattended-Upgrade::Allowed-Origins {
    "${distro_id}:${distro_codename}";
    "${distro_id}:${distro_codename}-security";
    "${distro_id}:${distro_codename}-updates";
    "${distro_id}ESMApps:${distro_codename}-apps-security";
    "${distro_id}ESM:${distro_codename}-infra-security";
    "Docker:${distro_codename}";
};
Unattended-Upgrade::Automatic-Reboot "true";
Unattended-Upgrade::Automatic-Reboot-Time "03:00";
Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
Unattended-Upgrade::Remove-Unused-Dependencies "true";
Unattended-Upgrade::Remove-New-Unused-Dependencies "true";
Unattended-Upgrade::Mail "";
Unattended-Upgrade::SyslogEnable "true";
UPGEOF

    cat > /etc/apt/apt.conf.d/20auto-upgrades << 'AUTOEOF'
APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Unattended-Upgrade "1";
APT::Periodic::Download-Upgradeable-Packages "1";
APT::Periodic::AutocleanInterval "7";
AUTOEOF

    log_success "Automatic updates configured (auto-reboot at 3am UTC)"
}

cmd_setup() {
    local ports="$DEFAULT_PORTS"
    local timezone="$DEFAULT_TIMEZONE"

    # Parse setup-specific flags
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --ports) ports="$2"; shift 2 ;;
            --timezone) timezone="$2"; shift 2 ;;
            *) echo -e "${RED}Unknown option: $1${NC}"; exit 1 ;;
        esac
    done

    echo -e "${CYAN}=== Server Setup ===${NC}"
    echo "  Ports:    $ports"
    echo "  Timezone: $timezone"
    echo ""

    if ! confirm_action "Proceed with full server setup?"; then
        echo "Cancelled"
        exit 0
    fi

    cmd_setup_docker
    echo ""
    cmd_setup_ufw "$ports"
    echo ""
    cmd_setup_ssh
    echo ""
    cmd_setup_updates
    echo ""

    timedatectl set-timezone "$timezone"

    apt-get autoremove -y
    apt-get clean

    log_success "Server setup complete!"
}

main() {
    parse_global_flags "$@"
    set -- "${REMAINING_ARGS[@]}"

    local cmd=${1:-}
    if [[ -z "$cmd" ]]; then
        usage "$0"
    fi

    case "$cmd" in
        setup)          shift; cmd_setup "$@" ;;
        setup-docker)   cmd_setup_docker ;;
        setup-ufw)      cmd_setup_ufw "${2:-$DEFAULT_PORTS}" ;;
        setup-ssh)      cmd_setup_ssh ;;
        setup-updates)  cmd_setup_updates ;;
        -h|--help|help) usage "$0" ;;
        *)
            echo -e "${RED}Unknown command: $cmd${NC}"
            usage "$0"
            ;;
    esac
}

main "$@"
